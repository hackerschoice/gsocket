
# Should be executed after deploy.sh has changed or after
# stealth binaries have been build.
name: Auto upload deploy.sh to gsocket.io/y
# on: [workflow_dispatch]
on:
  push:
    branches:
      - master
      - beta
    paths:
      - deploy/deploy.sh
      - deploy/deploy_server.sh
  workflow_dispatch:

env:
  DSTDIR: ${{ github.ref == 'refs/heads/master' && '/' || '/beta' }}

jobs:
  build:
    name: Deploy to WWW
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Adding bincrypter stub
      run: |
        curl -SsfL https://github.com/hackerschoice/bincrypter/releases/latest/download/bincrypter | sed -n '/%%BEGIN_BC_FUNC%%/,/%%END_BC_FUNC%%/p' | grep -vE '(^\s*$|^\s*\#)' >/tmp/bc_stub
        perl -ne 'print; if (/^# %%BINCRYPTER_HOOK%%/) { open($i,"<","/tmp/bc_stub"); print(<$i>); }; ' <deploy/deploy.sh >/tmp/y

    - name: Adding BRANCH
      run: |
        [ ! -d ~/.ssh ] && mkdir ~/.ssh
        cp deploy/deploy_server.sh /tmp/ys
        sed "s|^CICD_GS_BRANCH=.*|CICD_GS_BRANCH=\"${DSTDIR:1}\"|" -i "/tmp/y"
        sed "s|^CICD_GS_BRANCH=.*|CICD_GS_BRANCH=\"${DSTDIR:1}\"|" -i "/tmp/ys"

    - name: Clone GH binary
      env:
        SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY_GH_BINARY }}
      run: |
        echo "$SSH_DEPLOY_KEY" >~/.ssh/id_ed25519 && chmod 600 ~/.ssh/id_ed25519
        cd /tmp/
        git clone -b main --depth 1 --single-branch git@github.com:hackerschoice/binary.git

    - name: Clone https://gsocket.io
      env:
        SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
      run: |
        echo "$SSH_DEPLOY_KEY" >~/.ssh/id_ed25519 && chmod 600 ~/.ssh/id_ed25519
        cd /tmp/
        git clone -b gh-pages --depth 1 --single-branch git@github.com:hackerschoice/gsocket.io.git

    - name: Building deploy-all.sh (from gsocket.io bins)
      run: |
        cmp -s /tmp/y "/tmp/binary/gsocket${DSTDIR:?}/y" || {
          cp "${GITHUB_WORKSPACE:?}/deploy/deploy.sh" "/tmp/gsocket.io${DSTDIR}/bin/deploy.sh"
          "${GITHUB_WORKSPACE:?}/packaging/deploy-all/build.sh" /tmp/deploy-all.sh "/tmp/gsocket.io${DSTDIR:?}/bin"
          rm -f "gsocket.io${DSTDIR}/bin/deploy.sh"
        }

    - name: Uploading to GH binary
      env:
        SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY_GH_BINARY }}
      run: |
        echo "$SSH_DEPLOY_KEY" >~/.ssh/id_ed25519 && chmod 600 ~/.ssh/id_ed25519

        mkdir -p "/tmp/binary/gsocket${DSTDIR:?}/bin" 2>/dev/null
        cd "/tmp/binary/gsocket${DSTDIR:?}"
        if [ -f /tmp/deploy-all.sh ]; then
          cmp -s /tmp/deploy-all.sh bin/deploy-all.sh || { cat /tmp/deploy-all.sh >bin/deploy-all.sh; is_updated=1; }
        fi
        cmp -s /tmp/y y   || { cat /tmp/y >x;   cat /tmp/y >y;   is_updated=1; }
        cmp -s /tmp/ys ys || { cat /tmp/ys >xs; cat /tmp/ys >ys; is_updated=1; }
        [ -n $is_updated ] && {
          git config --local user.name "GitHub Action"
          git config --local user.email "root@proton.thc.org"
          git add bin/deploy-all.sh x xs y ys && git commit -m "deploy y & ys" && git push
        }

    - name: Uploading to https://gsocket.io
      env:
        SSH_DEPLOY_KEY: ${{ secrets.SSH_DEPLOY_KEY }}
      run: |
        echo "$SSH_DEPLOY_KEY" >~/.ssh/id_ed25519 && chmod 600 ~/.ssh/id_ed25519
        sed 's|^URL_BASE_CDN=.*|URL_BASE_CDN="https://gsocket.io"|' -i "/tmp/y"
        sed 's|^URL_BASE_X=.*|URL_BASE_X="https://gsocket.io"|' -i "/tmp/y"

        cd "/tmp/gsocket.io${DSTDIR:?}"
        if [ -f /tmp/deploy-all.sh ]; then
          cmp -s /tmp/deploy-all.sh bin/deploy-all.sh || { cat /tmp/deploy-all.sh >bin/deploy-all.sh; is_updated=1; }
        fi
        cmp -s /tmp/y y   || { cat /tmp/y >x;   cat /tmp/y >y;   is_updated=1; }
        cmp -s /tmp/ys ys || { cat /tmp/ys >xs; cat /tmp/ys >ys; is_updated=1; }
        [ -n $is_updated ] && {
          git config --local user.name "GitHub Action"
          git config --local user.email "root@proton.thc.org"
          git add bin/deploy-all.sh x xs y ys && git commit -m "deploy y & ys" && git push
        }
  
